---
title: "p8105-hw6-yz4994"
output: github_document
date: "2025-11-30"
---
```{r library}
library(tidyverse)
library(broom)
library(janitor)
library(purrr)
library(ggplot2)
library(modelr)
```
### Problem 1
```{r}
# Load data

homicide_raw = read_csv("homicide-data.csv") |> 
  clean_names()

# Clean data

homicide = 
  homicide_raw |> 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    solved = if_else(disposition == "Closed by arrest", 1, 0),
    victim_race = if_else(victim_race %in% c("White", "Black"), victim_race, NA),
    victim_age = as.numeric(victim_age)
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", 
                       "Kansas City, MO", "Tulsa, AL"),
    !is.na(victim_race)
  )

# Baltimore-only

baltimore = 
  homicide |> 
  filter(city_state == "Baltimore, MD")

# Logistic regression

baltimore_fit = 
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = baltimore,
    family = binomial()
  )

# Tidy + get ORs

baltimore_tidy = 
  tidy(baltimore_fit, conf.int = TRUE, exponentiate = TRUE)

# Extract adjusted OR: male vs female
male_or = 
  baltimore_tidy |> 
  filter(term == "victim_sexMale") |> 
  select(estimate, conf.low, conf.high)

male_or

```

```{r }
# Fit logistic model for each city

city_or_results = 
  homicide |> 
  nest(data = -city_state) |> 
  mutate(
    models = map(
      data,
      ~ glm(
          solved ~ victim_age + victim_sex + victim_race,
          data = .x,
          family = binomial()
        )
    ),
    results = map(models, ~ tidy(.x, conf.int = TRUE, exponentiate = TRUE))
  ) |> 
  select(city_state, results) |> 
  unnest(results) |> 
  filter(term == "victim_sexMale") |> 
  select(
    city_state,
    estimate,
    conf.low,
    conf.high
  ) |> 
  arrange(estimate)

city_or_results


```

```{r OR and CI plot}
library(ggplot2)

city_or_results |> 
  mutate(city_state = fct_reorder(city_state, estimate)) |> 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point(color = "#4F46E5", size = 2) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = 0.2, color = "#6366F1") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
  coord_flip() +
  labs(
    title = "Adjusted Odds Ratios for Solved Homicides (Male vs Female Victims)",
    x = "City",
    y = "Adjusted OR (Male vs Female)"
  ) +
  theme_minimal(base_size = 14)

```
The plot shows large variation across cities in the adjusted odds of solving homicides involving male versus female victims. In most cities, the estimated ORs are close to 1 and confidence intervals are wide and include 1, indicating no clear evidence that victim sex affects case resolution. A few cities show ORs substantially above or below 1, but these estimates are highly uncertain and likely reflect smaller sample sizes. Overall, the relationship between victim sex and homicide resolution appears inconsistent and city-specific, with no strong, generalizable pattern across the U.S.

### Problem 2
```{r}
library(p8105.datasets)
data("weather_df")
```

```{r bootstrap}
set.seed(1)
# Bootstrap

boot_results = 
  tibble(rep = 1:5000) |> 
  mutate(
    sample = map(rep, ~ sample_n(weather_df, size = nrow(weather_df), replace = TRUE)),
    model  = map(sample, ~ lm(tmax ~ tmin + prcp, data = .x)),
    glance = map(model, glance),
    tidy   = map(model, tidy),

    r2 = map_dbl(glance, "r.squared"),

    beta1 = map_dbl(tidy, ~ .x$estimate[.x$term == "tmin"]),
    beta2 = map_dbl(tidy, ~ .x$estimate[.x$term == "prcp"]),
    beta_ratio = beta1 / beta2
  ) |> 
  select(rep, r2, beta_ratio)

```

```{r histogram of r square}
boot_results |> 
  ggplot(aes(x = r2)) +
  geom_histogram(bins = 40, fill = "#4F46E5", color = "white") +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of R²")

```
The bootstrap distribution of r_square is tight, symmetric, and approximately normal, centered near the observed sample value (around 0.94). This indicates that the model’s explanatory power—how well tmin and prcp predict tmax—is stable across bootstrap samples.
The narrow spread of the distribution suggests low variability and a high degree of confidence in the estimated r_square.

```{r histogram of beta}
boot_results |> 
  ggplot(aes(x = beta_ratio)) +
  geom_histogram(bins = 40, fill = "#06B6D4", color = "white") +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of β₁ / β₂")
```
In contrast, the bootstrap distribution of the ratio is much wider, more variable, and noticeably right-skewed.
This behavior arises because the denominator (the coefficient for prcp) is small and noisy, so small changes in the fitted model can produce large swings in the ratio, including extreme negative values.
The wide spread and skewness show that the ratio is a highly unstable statistic, making bootstrap inference especially valuable since its sampling distribution is far from normal and cannot be well described analytically.

```{r histogram of CI}
ci_r2 = quantile(boot_results$r2, c(0.025, 0.975))
ci_ratio = quantile(boot_results$beta_ratio, c(0.025, 0.975))

ci_r2
ci_ratio

```

### Problem 3
```{r import dataset}
birthweight_raw = read_csv("birthweight.csv") |> 
  clean_names()

# Convert variables to appropriate types
birthweight = 
  birthweight_raw |>
  mutate(
    babysex = factor(babysex, labels = c("male", "female")),
    frace = factor(frace,
                   levels = c(1, 2, 3, 4, 8, 9),
                   labels = c("white", "black", "asian", "puerto_rican", "other", "unknown")),
    mrace = factor(mrace,
                   levels = c(1, 2, 3, 4, 8),
                   labels = c("white", "black", "asian", "puerto_rican", "other")),
    malform = factor(malform, labels = c("absent", "present"))
  )
# Count missing values in each variable
birthweight |> summarise(across(everything(), ~ sum(is.na(.))))
```

```{r fit model}
model_bw = 
  birthweight |> 
  lm(bwt ~ bhead + blength + gaweeks + babysex + 
       ppbmi + wtgain + smoken + mrace, data = _)

summary(model_bw)

birthweight_aug = 
  birthweight |> 
  add_predictions(model_bw) |> 
  add_residuals(model_bw)

birthweight_aug |> 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.3, color = "#4F46E5") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Residuals vs Fitted Values for Birthweight Model",
    x = "Fitted Values",
    y = "Residuals"
  )

```

```{r model 1}
model_main = 
  lm(bwt ~ bhead + blength + gaweeks + babysex +
       ppbmi + wtgain + smoken + mrace,
     data = birthweight)
```

```{r model 2}
model_len_age = 
  lm(bwt ~ blength + gaweeks, data = birthweight)
```

```{r model 3}
model_interactions = 
  lm(bwt ~ bhead * blength * babysex, data = birthweight)
```

```{r monte carlo}
set.seed(123)

cv_df = 
  crossv_mc(birthweight, n = 100, test = 0.2) |> 
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble)
  )
```

```{r fit in CV folds}
cv_df =
  cv_df |> 
  mutate(
    fit_main = map(train, ~ lm(bwt ~ bhead + blength + gaweeks + babysex +
                                 ppbmi + wtgain + smoken + mrace, data = .x)),
    
    fit_len_age = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    
    fit_interactions = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x))
  )
#RMSE
cv_results = 
  cv_df |> 
  mutate(
    rmse_main = map2_dbl(fit_main, test,
                         ~ sqrt(mean((.y$bwt - predict(.x, .y))^2))),
    
    rmse_len_age = map2_dbl(fit_len_age, test,
                            ~ sqrt(mean((.y$bwt - predict(.x, .y))^2))),
    
    rmse_interactions = map2_dbl(fit_interactions, test,
                                 ~ sqrt(mean((.y$bwt - predict(.x, .y))^2)))
  )
```

```{r plot}
cv_long =
  cv_results |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse"
  ) |> 
  mutate(model = recode(model,
                        rmse_main = "Proposed model",
                        rmse_len_age = "Length + gestational age",
                        rmse_interactions = "Three-way interaction model"))

cv_long |> 
  ggplot(aes(x = model, y = rmse)) +
  geom_boxplot(fill = "#4F46E5", alpha = 0.6) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Cross-Validated RMSE for Birthweight Models",
    x = "Model",
    y = "RMSE"
  )

```
1. Length + gestational age (simple model)
This model has the highest RMSE and substantial variability across folds.
This indicates that although length and gestational age are important predictors, the model is too simple and fails to capture much of the variation in birthweight.

2. Proposed model (moderate complexity)
The proposed model achieves the lowest RMSE and is also the most stable across CV folds.
This suggests that incorporating biologically relevant predictors (e.g., head circumference, maternal characteristics, smoking) substantially improves predictive accuracy without overfitting.

3. Three-way interaction model (high complexity)
This model performs worse than the proposed model and shows greater variability in RMSE.
Although interactions add flexibility, the full three-way interaction structure appears too complex, leading to overfitting and reduced out-of-sample accuracy.